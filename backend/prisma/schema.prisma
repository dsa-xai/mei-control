// Schema do Banco de Dados - MEI Control
// Prisma ORM com PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USUÁRIOS E AUTENTICAÇÃO
// ============================================

model Usuario {
  id              String    @id @default(uuid())
  email           String    @unique
  senha           String
  nome            String
  cpf             String    @unique
  telefone        String?
  telefoneWhatsApp String?  @map("telefone_whatsapp")
  role            String    @default("CLIENTE") // ADMIN, CLIENTE
  
  tokenAcesso     String?   @unique @map("token_acesso")
  tokenExpira     DateTime? @map("token_expira")
  
  ativo           Boolean   @default(true)
  emailVerificado Boolean   @default(false) @map("email_verificado")
  primeiroAcesso  Boolean   @default(true) @map("primeiro_acesso")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  meis            MEI[]
  sessoes         Sessao[]
  notificacoes    Notificacao[]
  solicitacoesFeitas SolicitacaoNota[] @relation("SolicitanteRelation")

  @@map("usuarios")
}

model Sessao {
  id          String   @id @default(uuid())
  usuarioId   String   @map("usuario_id")
  token       String   @unique
  ip          String?
  userAgent   String?  @map("user_agent")
  expiraEm    DateTime @map("expira_em")
  createdAt   DateTime @default(now()) @map("created_at")

  usuario     Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([usuarioId])
  @@map("sessoes")
}

// ============================================
// MEI E DADOS FISCAIS
// ============================================

model MEI {
  id              String   @id @default(uuid())
  usuarioId       String   @map("usuario_id")
  
  cnpj            String   @unique
  razaoSocial     String   @map("razao_social")
  nomeFantasia    String?  @map("nome_fantasia")
  
  atividadePrincipal String? @map("atividade_principal")
  cnaePrincipal   String?  @map("cnae_principal")
  
  endereco        String?
  cidade          String?
  estado          String?
  cep             String?
  
  inscricaoMunicipal String? @map("inscricao_municipal")
  inscricaoEstadual  String? @map("inscricao_estadual")
  
  dataAbertura    DateTime? @map("data_abertura")
  situacao        String    @default("ATIVA")
  
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  usuario         Usuario   @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  notasFiscais    NotaFiscal[]
  clientes        Cliente[]
  das             DAS[]
  faturamentos    Faturamento[]
  solicitacoes    SolicitacaoNota[]

  @@index([usuarioId])
  @@map("meis")
}

model Cliente {
  id          String   @id @default(uuid())
  meiId       String   @map("mei_id")
  
  tipo        String   @default("PJ") // PF, PJ
  nome        String
  cpfCnpj     String   @map("cpf_cnpj")
  email       String?
  telefone    String?
  endereco    String?
  cidade      String?
  estado      String?
  cep         String?
  
  ativo       Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  mei         MEI      @relation(fields: [meiId], references: [id], onDelete: Cascade)
  notasFiscais NotaFiscal[]
  solicitacoes SolicitacaoNota[]

  @@unique([meiId, cpfCnpj])
  @@index([meiId])
  @@map("clientes")
}

// ============================================
// NOTAS FISCAIS
// ============================================

model NotaFiscal {
  id              String    @id @default(uuid())
  meiId           String    @map("mei_id")
  clienteId       String?   @map("cliente_id")
  solicitacaoId   String?   @unique @map("solicitacao_id")
  
  numero          Int
  serie           String    @default("1")
  
  dataEmissao     DateTime  @map("data_emissao")
  dataCompetencia DateTime? @map("data_competencia")
  
  descricao       String
  valor           Decimal   @db.Decimal(15, 2)
  
  impostoIss      Decimal?  @db.Decimal(15, 2) @map("imposto_iss")
  aliquotaIss     Decimal?  @db.Decimal(5, 2) @map("aliquota_iss")
  
  status          String    @default("EMITIDA") // EMITIDA, CANCELADA, SUBSTITUIDA
  motivoCancelamento String? @map("motivo_cancelamento")
  
  codigoVerificacao String? @map("codigo_verificacao")
  xmlUrl          String?   @map("xml_url")
  pdfUrl          String?   @map("pdf_url")
  
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  mei             MEI       @relation(fields: [meiId], references: [id], onDelete: Cascade)
  cliente         Cliente?  @relation(fields: [clienteId], references: [id])
  solicitacao     SolicitacaoNota? @relation(fields: [solicitacaoId], references: [id])

  @@unique([meiId, numero, serie])
  @@index([meiId])
  @@index([dataEmissao])
  @@map("notas_fiscais")
}

// ============================================
// SOLICITAÇÕES DE NOTA (CLIENTES)
// ============================================

model SolicitacaoNota {
  id              String    @id @default(uuid())
  meiId           String    @map("mei_id")
  clienteId       String?   @map("cliente_id")
  solicitanteId   String    @map("solicitante_id")
  
  // Dados da solicitação
  descricao       String
  valor           Decimal   @db.Decimal(15, 2)
  
  // Áudio da descrição (opcional)
  audioUrl        String?   @map("audio_url")
  audioTranscricao String?  @map("audio_transcricao")
  
  // Dados do tomador (se diferente do cliente)
  tomadorNome     String?   @map("tomador_nome")
  tomadorCpfCnpj  String?   @map("tomador_cpf_cnpj")
  tomadorEmail    String?   @map("tomador_email")
  
  // Workflow
  status          String    @default("PENDENTE") // PENDENTE, EM_ANDAMENTO, EMITIDA, REJEITADA
  observacao      String?
  motivoRejeicao  String?   @map("motivo_rejeicao")
  
  processadoPor   String?   @map("processado_por")
  processadoEm    DateTime? @map("processado_em")
  
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  mei             MEI       @relation(fields: [meiId], references: [id], onDelete: Cascade)
  cliente         Cliente?  @relation(fields: [clienteId], references: [id])
  solicitante     Usuario   @relation("SolicitanteRelation", fields: [solicitanteId], references: [id])
  notaFiscal      NotaFiscal?

  @@index([meiId])
  @@index([status])
  @@map("solicitacoes_notas")
}

// ============================================
// DAS E FATURAMENTO
// ============================================

model DAS {
  id              String    @id @default(uuid())
  meiId           String    @map("mei_id")
  
  competencia     DateTime  // Mês/Ano de referência
  dataVencimento  DateTime  @map("data_vencimento")
  dataPagamento   DateTime? @map("data_pagamento")
  
  valor           Decimal   @db.Decimal(15, 2)
  valorPago       Decimal?  @db.Decimal(15, 2) @map("valor_pago")
  
  status          String    @default("PENDENTE") // PENDENTE, PAGO, ATRASADO, PARCELADO
  codigoBarras    String?   @map("codigo_barras")
  linhaDigitavel  String?   @map("linha_digitavel")
  
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  mei             MEI       @relation(fields: [meiId], references: [id], onDelete: Cascade)

  @@unique([meiId, competencia])
  @@index([meiId])
  @@index([dataVencimento])
  @@map("das")
}

model Faturamento {
  id              String   @id @default(uuid())
  meiId           String   @map("mei_id")
  
  ano             Int
  mes             Int
  valor           Decimal  @db.Decimal(15, 2)
  quantidadeNotas Int      @default(0) @map("quantidade_notas")
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  mei             MEI      @relation(fields: [meiId], references: [id], onDelete: Cascade)

  @@unique([meiId, ano, mes])
  @@index([meiId])
  @@map("faturamentos")
}

// ============================================
// NOTIFICAÇÕES
// ============================================

model Notificacao {
  id          String    @id @default(uuid())
  usuarioId   String    @map("usuario_id")
  
  tipo        String    // ALERTA_TETO, DAS_VENCENDO, NOTA_SOLICITADA, NOTA_EMITIDA, etc
  titulo      String
  mensagem    String
  dados       Json?
  
  lida        Boolean   @default(false)
  lidaEm      DateTime? @map("lida_em")
  
  createdAt   DateTime  @default(now()) @map("created_at")

  usuario     Usuario   @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([usuarioId])
  @@index([lida])
  @@map("notificacoes")
}

// ============================================
// LOGS DE ATIVIDADE
// ============================================

model LogAtividade {
  id              String   @id @default(uuid())
  usuarioId       String?  @map("usuario_id")
  meiId           String?  @map("mei_id")
  
  acao            String   // CREATE, UPDATE, DELETE, LOGIN, LOGOUT, etc
  entidade        String   // Usuario, MEI, NotaFiscal, etc
  entidadeId      String?  @map("entidade_id")
  
  dadosAntigos    Json?    @map("dados_antigos")
  dadosNovos      Json?    @map("dados_novos")
  
  ip              String?
  userAgent       String?  @map("user_agent")
  
  createdAt       DateTime @default(now()) @map("created_at")

  @@index([usuarioId])
  @@index([meiId])
  @@index([createdAt])
  @@map("logs_atividades")
}
