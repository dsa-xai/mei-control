// Schema do Banco de Dados - MEI Control
// Usando Prisma ORM com PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USUÁRIOS E AUTENTICAÇÃO
// ============================================

model Usuario {
  id              String    @id @default(uuid())
  email           String    @unique
  senha           String
  nome            String
  cpf             String    @unique
  telefone        String?
  ativo           Boolean   @default(true)
  emailVerificado Boolean   @default(false) @map("email_verificado")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relacionamentos
  meis            MEI[]
  sessoes         Sessao[]
  notificacoes    Notificacao[]

  @@map("usuarios")
}

model Sessao {
  id          String   @id @default(uuid())
  usuarioId   String   @map("usuario_id")
  token       String   @unique
  ip          String?
  userAgent   String?  @map("user_agent")
  expiraEm    DateTime @map("expira_em")
  createdAt   DateTime @default(now()) @map("created_at")

  usuario     Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@map("sessoes")
}

// ============================================
// MEI - MICROEMPREENDEDOR INDIVIDUAL
// ============================================

model MEI {
  id              String    @id @default(uuid())
  usuarioId       String    @map("usuario_id")
  cnpj            String    @unique
  razaoSocial     String    @map("razao_social")
  nomeFantasia    String?   @map("nome_fantasia")
  dataAbertura    DateTime  @map("data_abertura")
  cnaePrincipal   String    @map("cnae_principal")
  cnaeDescricao   String?   @map("cnae_descricao")
  
  // Endereço
  cep             String?
  logradouro      String?
  numero          String?
  complemento     String?
  bairro          String?
  cidade          String?
  uf              String?
  
  // Configurações
  tetoAnual       Decimal   @default(81000) @map("teto_anual") @db.Decimal(12, 2)
  alertaPercentual Int      @default(80) @map("alerta_percentual")
  
  // Status
  ativo           Boolean   @default(true)
  situacao        String    @default("ATIVA") // ATIVA, SUSPENSA, BAIXADA
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relacionamentos
  usuario         Usuario   @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  clientes        Cliente[]
  notasFiscais    NotaFiscal[]
  dasGuias        DASGuia[]
  declaracoes     DeclaracaoAnual[]

  @@map("meis")
}

// ============================================
// CLIENTES
// ============================================

model Cliente {
  id              String    @id @default(uuid())
  meiId           String    @map("mei_id")
  tipo            String    @default("PJ") // PF ou PJ
  nome            String
  cpfCnpj         String    @map("cpf_cnpj")
  email           String?
  telefone        String?
  
  // Endereço
  cep             String?
  logradouro      String?
  numero          String?
  complemento     String?
  bairro          String?
  cidade          String?
  uf              String?
  
  // Metadados
  observacoes     String?
  ativo           Boolean   @default(true)
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relacionamentos
  mei             MEI       @relation(fields: [meiId], references: [id], onDelete: Cascade)
  notasFiscais    NotaFiscal[]

  @@unique([meiId, cpfCnpj])
  @@map("clientes")
}

// ============================================
// NOTAS FISCAIS
// ============================================

model NotaFiscal {
  id              String    @id @default(uuid())
  meiId           String    @map("mei_id")
  clienteId       String    @map("cliente_id")
  
  // Dados da Nota
  numero          String
  serie           String    @default("1")
  valor           Decimal   @db.Decimal(12, 2)
  descricao       String
  
  // Datas
  dataEmissao     DateTime  @map("data_emissao")
  dataCompetencia DateTime  @map("data_competencia")
  
  // Status
  status          String    @default("EMITIDA") // RASCUNHO, EMITIDA, CANCELADA
  motivoCancelamento String? @map("motivo_cancelamento")
  dataCancelamento DateTime? @map("data_cancelamento")
  
  // Integração (para uso futuro com NFS-e)
  codigoVerificacao String? @map("codigo_verificacao")
  linkPdf         String?   @map("link_pdf")
  xmlNota         String?   @map("xml_nota")
  
  // Metadados
  observacoes     String?
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relacionamentos
  mei             MEI       @relation(fields: [meiId], references: [id], onDelete: Cascade)
  cliente         Cliente   @relation(fields: [clienteId], references: [id])

  @@unique([meiId, numero, serie])
  @@index([meiId, dataEmissao])
  @@index([meiId, status])
  @@map("notas_fiscais")
}

// ============================================
// DAS - DOCUMENTO DE ARRECADAÇÃO
// ============================================

model DASGuia {
  id              String    @id @default(uuid())
  meiId           String    @map("mei_id")
  
  // Dados da Guia
  competencia     DateTime  // Mês/Ano de referência
  vencimento      DateTime
  valor           Decimal   @db.Decimal(10, 2)
  
  // Composição do valor
  valorInss       Decimal   @map("valor_inss") @db.Decimal(10, 2)
  valorIcms       Decimal   @default(0) @map("valor_icms") @db.Decimal(10, 2)
  valorIss        Decimal   @default(0) @map("valor_iss") @db.Decimal(10, 2)
  
  // Status
  status          String    @default("PENDENTE") // PENDENTE, PAGO, VENCIDO, PARCELADO
  dataPagamento   DateTime? @map("data_pagamento")
  
  // Código de barras / Pix
  linhaDigitavel  String?   @map("linha_digitavel")
  codigoBarras    String?   @map("codigo_barras")
  qrCodePix       String?   @map("qr_code_pix")
  
  // Metadados
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relacionamentos
  mei             MEI       @relation(fields: [meiId], references: [id], onDelete: Cascade)

  @@unique([meiId, competencia])
  @@map("das_guias")
}

// ============================================
// DECLARAÇÃO ANUAL (DASN-SIMEI)
// ============================================

model DeclaracaoAnual {
  id                  String    @id @default(uuid())
  meiId               String    @map("mei_id")
  anoCalendario       Int       @map("ano_calendario")
  
  // Valores declarados
  receitaBrutaTotal   Decimal   @map("receita_bruta_total") @db.Decimal(12, 2)
  receitaComercio     Decimal   @default(0) @map("receita_comercio") @db.Decimal(12, 2)
  receitaIndustria    Decimal   @default(0) @map("receita_industria") @db.Decimal(12, 2)
  receitaServicos     Decimal   @default(0) @map("receita_servicos") @db.Decimal(12, 2)
  
  // Funcionário
  possuiFuncionario   Boolean   @default(false) @map("possui_funcionario")
  
  // Status
  status              String    @default("RASCUNHO") // RASCUNHO, ENVIADA, RETIFICADORA
  dataEnvio           DateTime? @map("data_envio")
  numeroRecibo        String?   @map("numero_recibo")
  
  // Metadados
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  // Relacionamentos
  mei                 MEI       @relation(fields: [meiId], references: [id], onDelete: Cascade)

  @@unique([meiId, anoCalendario])
  @@map("declaracoes_anuais")
}

// ============================================
// NOTIFICAÇÕES
// ============================================

model Notificacao {
  id              String    @id @default(uuid())
  usuarioId       String    @map("usuario_id")
  
  tipo            String    // ALERTA_TETO, VENCIMENTO_DAS, DECLARACAO_ANUAL, SISTEMA
  titulo          String
  mensagem        String
  prioridade      String    @default("NORMAL") // BAIXA, NORMAL, ALTA, CRITICA
  
  lida            Boolean   @default(false)
  dataLeitura     DateTime? @map("data_leitura")
  
  // Link de ação (opcional)
  linkAcao        String?   @map("link_acao")
  
  createdAt       DateTime  @default(now()) @map("created_at")

  // Relacionamentos
  usuario         Usuario   @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([usuarioId, lida])
  @@map("notificacoes")
}

// ============================================
// CONFIGURAÇÕES DO SISTEMA
// ============================================

model ConfiguracaoSistema {
  id              String    @id @default(uuid())
  chave           String    @unique
  valor           String
  descricao       String?
  tipo            String    @default("STRING") // STRING, NUMBER, BOOLEAN, JSON
  editavel        Boolean   @default(true)
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@map("configuracoes_sistema")
}

// ============================================
// LOG DE ATIVIDADES (AUDITORIA)
// ============================================

model LogAtividade {
  id              String    @id @default(uuid())
  usuarioId       String?   @map("usuario_id")
  meiId           String?   @map("mei_id")
  
  acao            String    // CREATE, UPDATE, DELETE, LOGIN, LOGOUT, etc
  entidade        String    // Usuario, MEI, NotaFiscal, etc
  entidadeId      String?   @map("entidade_id")
  
  dadosAntigos    Json?     @map("dados_antigos")
  dadosNovos      Json?     @map("dados_novos")
  
  ip              String?
  userAgent       String?   @map("user_agent")
  
  createdAt       DateTime  @default(now()) @map("created_at")

  @@index([usuarioId])
  @@index([meiId])
  @@index([createdAt])
  @@map("logs_atividades")
}
